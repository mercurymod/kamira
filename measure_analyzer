#!/usr/bin/env coffee
program = require('commander')
fs = require("fs")
path = require('path')
jsmeter = require("jsmeter-fixed").jsmeter
_ = require("underscore")
program.version('0.0.1')
  .option('-M, --measures <path>', 'measures directory')
  .option("-D --util-dir <path>", 'util directory')
  .parse(process.argv)
parse = require("./parse").make_parse()
tokens = require("./tokens")
metrics = require("./metrics")
tokens.setup()
utilMethods=[]
utilFiles = fs.readdirSync program.utilDir
for file in utilFiles
  continue if file == ".DS_Store"
  pathName = path.join program.utilDir, file
  # console.log(pathName)
  content = fs.readFileSync(pathName).toString()
  utilsReport = jsmeter.run(content, file)
  utilMethods = utilMethods.concat(utilsReport)

fs.readdir program.measures, (err, files) ->
  console.log(err) if err?
  measures = []
  for file in files
    continue if file == ".DS_Store"    
    pathName = path.join program.measures, file
    # console.log(pathName)
    js = fs.readFileSync(pathName).toString()
    js = js.replace(/<%=.*effective_date.*%>/, 1347983662)
    js = js.replace("<%= init_js_frameworks %>", "")
    json = JSON.parse(js)
    tree = parse(json.map_fn)

    measure = jsmeter.run(json.map_fn, file)
    complexitySet = _.union(utilMethods, measure)
    
    report = metrics.report(tree, complexitySet)
    report["id"] = json.nqf_id
    measures.push(report)
  console.log(JSON.stringify(measures))
    # return
    #for func in result
      #operators = _.union(operators, _.keys(func.operators))
      #operands = _.union(operands, _.keys(func.operands))
      #operatorCount += func.operatorCount
      #operandCount += func.operandCount
    #uniqueOperators = operators.length
    #uniqueOperands = operands.length
    #complexity = edges - nodes + 2 * exits
    #console.log("Complexity: " + complexity)
    #difficulty = (uniqueOperators / 2) * (operandCount / uniqueOperators)
    #console.log("Difficulty: " + difficulty)
    #length = (operatorCount + operandCount)
    #vocab = (uniqueOperators + uniqueOperands)
    #volume = length * Math.log(vocab)
    #console.log("Volume: " + volume)
    #effort = difficulty * volume
    #console.log("Effort: " + effort)
    #time = effort / 18
    #console.log("Hours to Code: " + (time / 3600))
    #bugs = volume / 3000
    #console.log("Number of Bugs expected: " + bugs)
